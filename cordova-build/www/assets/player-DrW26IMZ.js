import{a as m,e as j,j as t,a3 as x,a7 as T,a8 as P,a4 as E,I as $,a5 as b,T as N,a6 as C}from"./index-D4yQWOYE.js";const y={position:"fixed",top:0,left:0,width:"100vw",height:"100vh",backgroundColor:"#000",color:"white",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",fontFamily:"sans-serif",textAlign:"center",padding:"1rem"},z={fontSize:"5vw",fontWeight:"bold",letterSpacing:"1vw",padding:"2rem",border:"2px solid #fff",borderRadius:"1rem",backgroundColor:"#333",marginTop:"2rem"},O=()=>{let o=localStorage.getItem("deviceHardwareId");return o||(o=`device_${Date.now()}_${Math.random().toString(36).substring(2,10)}`,localStorage.setItem("deviceHardwareId",o)),o};function W(){const[o,l]=m.useState("initializing"),[f,S]=m.useState(null),[v,w]=m.useState(null),[g,I]=m.useState(void 0),{data:n,isLoading:k,error:h}=j({queryKey:["/api/player/validate-token"],queryFn:async()=>{const c=localStorage.getItem("authToken");if(!c)throw new Error("No auth token found");try{const a=await fetch("/api/player/validate-token",{headers:{Authorization:`Bearer ${c}`}});if(!a.ok)throw a.status===401&&(localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),localStorage.removeItem("screenId"),l("initializing")),new Error(`Token validation failed: ${a.status}`);return a.json()}catch(a){throw console.error("Validation request failed:",a),a}},retry:!1,refetchInterval:!1,enabled:o==="paired",staleTime:10*60*1e3,refetchOnWindowFocus:!1,refetchOnReconnect:!1});return m.useEffect(()=>{const c=localStorage.getItem("authToken");if(c){fetch("/api/player/validate-token",{headers:{Authorization:`Bearer ${c}`}}).then(r=>{r.ok?l("paired"):(localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),l("initializing"))}).catch(()=>{localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),l("initializing")});return}const a=O();(async()=>{try{const r=await fetch("/api/screens/initiate-pairing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceHardwareId:a})});if(!r.ok){const d=await r.json();throw new Error(d.message||"No se pudo obtener el c√≥digo del servidor.")}const e=await r.json();S(e.pairingCode),l("pairing")}catch(r){w(r.message),l("error"),console.error("Error al iniciar emparejamiento:",r)}})();const i=new WebSocket(`wss://${window.location.host}/ws`);return i.onopen=()=>{console.log("üîå Player WebSocket connected for pairing"),i.send(JSON.stringify({type:"pairing-device",deviceId:a}));const r=localStorage.getItem("authToken"),e=localStorage.getItem("screenId");console.log(`üì± Player status - AuthToken: ${r?"Yes":"No"}, ScreenId: ${e}`),r&&e&&(console.log(`üÜî Identifying as screen ${e} for playlist changes`),console.log(`üîê Sending player-auth with token: ${r.substring(0,8)}...`),i.send(JSON.stringify({type:"player-auth",token:r})),setTimeout(()=>{console.log(`üè∑Ô∏è Sending screen-identify for screenId: ${e}`),i.send(JSON.stringify({type:"screen-identify",screenId:parseInt(e)}))},100))},i.onmessage=r=>{try{const e=JSON.parse(r.data);if(console.log("üì® Player WebSocket message received:",e.type,e),e.type==="pairing-completed"&&e.deviceId===a&&(console.log("‚úÖ ¬°Emparejamiento exitoso via WebSocket!",e),localStorage.setItem("authToken",e.authToken),localStorage.setItem("screenName",e.name),e.screenId&&(localStorage.setItem("screenId",e.screenId.toString()),console.log(`üíæ Screen ID ${e.screenId} guardado en localStorage`)),e.playlistId?localStorage.setItem("playlistId",e.playlistId.toString()):localStorage.removeItem("playlistId"),i.close(),l("paired")),e.type==="playlist-change"){console.log("üîÑ Playlist change received:",e.data);const{playlistId:d,screenId:p}=e.data,s=localStorage.getItem("screenId");console.log(`üìã Comparing screenIds: message=${p}, current=${s}`),p&&p.toString()===s&&(console.log(`üéµ Playlist changed to ${d} for this screen - RELOADING NOW`),window.location.reload())}e.type==="auth_success"&&console.log("‚úÖ Player authentication successful:",e.data),e.type==="auth_error"&&console.log("‚ùå Player authentication error:",e.data),e.type==="screen-identified"&&console.log("‚úÖ Screen identification confirmed:",e.data)}catch(e){console.error("Error parsing WebSocket message:",e)}},i.onerror=r=>{console.error("WebSocket error:",r);const e=setInterval(async()=>{if(o==="pairing")try{const d=encodeURIComponent(a),p=await fetch(`/api/screens/pairing-status/${d}`);if(!p.ok)return;const s=await p.json();s.status==="paired"&&(console.log("¬°Emparejamiento exitoso!",s),localStorage.setItem("authToken",s.authToken),localStorage.setItem("screenName",s.name),s.playlistId?localStorage.setItem("playlistId",s.playlistId.toString()):localStorage.removeItem("playlistId"),clearInterval(e),l("paired"))}catch(d){console.error("Error durante el polling de estado:",d)}},1e4);return()=>clearInterval(e)},()=>{i.readyState===WebSocket.OPEN&&i.close()}},[o]),m.useEffect(()=>{var c;if(n!=null&&n.valid&&((c=n.screen)!=null&&c.playlistId))console.log(`Screen playlist ID: ${n.screen.playlistId}, Current: ${g}`),n.screen.playlistId!==g&&(console.log(`Updating playlist ID from ${g} to ${n.screen.playlistId}`),I(n.screen.playlistId));else{const a=new URLSearchParams(window.location.search),u=a.get("playlistId")?parseInt(a.get("playlistId")):void 0;u&&!g&&I(u)}},[n,g]),o==="error"?t.jsxs("div",{style:y,children:[t.jsx("h1",{style:{color:"#ef4444"},children:"Error de Conexi√≥n"}),t.jsx("p",{style:{fontSize:"1.5vw",marginTop:"1rem"},children:v}),t.jsx("p",{style:{fontSize:"1vw",marginTop:"2rem",color:"#aaa"},children:"Verifica la consola para m√°s detalles. Reintentando..."})]}):o==="initializing"?t.jsx("div",{style:y,children:t.jsx("h1",{children:"Inicializando Dispositivo..."})}):o==="pairing"?t.jsxs("div",{style:y,children:[t.jsx("h1",{style:{fontSize:"3vw"},children:"Introduce este c√≥digo en tu panel de administraci√≥n:"}),f?t.jsx("div",{style:z,children:f}):t.jsx("p",{children:"Obteniendo c√≥digo..."})]}):o==="paired"?h?(console.error("Screen validation failed:",h),t.jsxs("div",{style:y,children:[t.jsx("h1",{style:{color:"#ef4444"},children:"Error de Validaci√≥n"}),t.jsx("p",{style:{fontSize:"1.5vw",marginTop:"1rem"},children:"La pantalla no est√° correctamente emparejada. Reiniciando..."})]})):k?t.jsx("div",{style:y,children:t.jsx("h1",{children:"Validando Pantalla..."})}):t.jsx(x,{playlistId:g,isPreview:!1}):null}T.GlobalWorkerOptions.workerSrc="/pdf.worker.js";P.createRoot(document.getElementById("root")).render(t.jsx(E,{client:$,children:t.jsx(b,{defaultTheme:"light",storageKey:"xcientv-ui-theme",children:t.jsxs(N,{children:[t.jsx(C,{}),t.jsx(W,{})]})})}));
