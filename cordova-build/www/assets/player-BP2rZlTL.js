import{a as y,e as x,j as t,$ as j,a3 as T,a0 as P,I as E,a1 as $,T as b,a2 as N}from"./index-DvCZ8l4H.js";const m={position:"fixed",top:0,left:0,width:"100vw",height:"100vh",backgroundColor:"#000",color:"white",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",fontFamily:"sans-serif",textAlign:"center",padding:"1rem"},C={fontSize:"5vw",fontWeight:"bold",letterSpacing:"1vw",padding:"2rem",border:"2px solid #fff",borderRadius:"1rem",backgroundColor:"#333",marginTop:"2rem"},z=()=>{let o=localStorage.getItem("deviceHardwareId");return o||(o=`device_${Date.now()}_${Math.random().toString(36).substring(2,10)}`,localStorage.setItem("deviceHardwareId",o)),o};function D(){const[o,c]=y.useState("initializing"),[I,S]=y.useState(null),[v,w]=y.useState(null),[g,h]=y.useState(void 0),{data:i,isLoading:k,error:f}=x({queryKey:["/api/player/validate-token"],queryFn:async()=>{const a=localStorage.getItem("authToken");if(!a)throw new Error("No auth token found");const n=await fetch("/api/player/validate-token",{headers:{Authorization:`Bearer ${a}`}});if(!n.ok)throw new Error("Token validation failed");return n.json()},retry:(a,n)=>n.message.includes("Token validation failed")?!1:a<3,refetchInterval:6e4,enabled:o==="paired",onError:a=>{console.error("Token validation error:",a),localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),c("initializing")}});return y.useEffect(()=>{const a=localStorage.getItem("authToken");if(a){fetch("/api/player/validate-token",{headers:{Authorization:`Bearer ${a}`}}).then(r=>{r.ok?c("paired"):(localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),c("initializing"))}).catch(()=>{localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),c("initializing")});return}const n=z();(async()=>{try{const r=await fetch("/api/screens/initiate-pairing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceHardwareId:n})});if(!r.ok){const d=await r.json();throw new Error(d.message||"No se pudo obtener el c√≥digo del servidor.")}const e=await r.json();S(e.pairingCode),c("pairing")}catch(r){w(r.message),c("error"),console.error("Error al iniciar emparejamiento:",r)}})();const s=new WebSocket(`wss://${window.location.host}/ws`);return s.onopen=()=>{console.log("üîå Player WebSocket connected for pairing"),s.send(JSON.stringify({type:"pairing-device",deviceId:n}));const r=localStorage.getItem("authToken"),e=localStorage.getItem("screenId");console.log(`üì± Player status - AuthToken: ${r?"Yes":"No"}, ScreenId: ${e}`),r&&e&&(console.log(`üÜî Identifying as screen ${e} for playlist changes`),console.log(`üîê Sending player-auth with token: ${r.substring(0,8)}...`),s.send(JSON.stringify({type:"player-auth",token:r})),setTimeout(()=>{console.log(`üè∑Ô∏è Sending screen-identify for screenId: ${e}`),s.send(JSON.stringify({type:"screen-identify",screenId:parseInt(e)}))},100))},s.onmessage=r=>{try{const e=JSON.parse(r.data);if(console.log("üì® Player WebSocket message received:",e.type,e),e.type==="pairing-completed"&&e.deviceId===n&&(console.log("‚úÖ ¬°Emparejamiento exitoso via WebSocket!",e),localStorage.setItem("authToken",e.authToken),localStorage.setItem("screenName",e.name),e.screenId&&(localStorage.setItem("screenId",e.screenId.toString()),console.log(`üíæ Screen ID ${e.screenId} guardado en localStorage`)),e.playlistId?localStorage.setItem("playlistId",e.playlistId.toString()):localStorage.removeItem("playlistId"),s.close(),c("paired")),e.type==="playlist-change"){console.log("üîÑ Playlist change received:",e.data);const{playlistId:d,screenId:p}=e.data,l=localStorage.getItem("screenId");console.log(`üìã Comparing screenIds: message=${p}, current=${l}`),p&&p.toString()===l&&(console.log(`üéµ Playlist changed to ${d} for this screen - RELOADING NOW`),window.location.reload())}e.type==="auth_success"&&console.log("‚úÖ Player authentication successful:",e.data),e.type==="auth_error"&&console.log("‚ùå Player authentication error:",e.data),e.type==="screen-identified"&&console.log("‚úÖ Screen identification confirmed:",e.data)}catch(e){console.error("Error parsing WebSocket message:",e)}},s.onerror=r=>{console.error("WebSocket error:",r);const e=setInterval(async()=>{if(o==="pairing")try{const d=encodeURIComponent(n),p=await fetch(`/api/screens/pairing-status/${d}`);if(!p.ok)return;const l=await p.json();l.status==="paired"&&(console.log("¬°Emparejamiento exitoso!",l),localStorage.setItem("authToken",l.authToken),localStorage.setItem("screenName",l.name),l.playlistId?localStorage.setItem("playlistId",l.playlistId.toString()):localStorage.removeItem("playlistId"),clearInterval(e),c("paired"))}catch(d){console.error("Error durante el polling de estado:",d)}},1e4);return()=>clearInterval(e)},()=>{s.readyState===WebSocket.OPEN&&s.close()}},[o]),y.useEffect(()=>{var a;if(i!=null&&i.valid&&((a=i.screen)!=null&&a.playlistId))console.log(`Screen playlist ID: ${i.screen.playlistId}, Current: ${g}`),i.screen.playlistId!==g&&(console.log(`Updating playlist ID from ${g} to ${i.screen.playlistId}`),h(i.screen.playlistId));else{const n=new URLSearchParams(window.location.search),u=n.get("playlistId")?parseInt(n.get("playlistId")):void 0;u&&!g&&h(u)}},[i,g]),o==="error"?t.jsxs("div",{style:m,children:[t.jsx("h1",{style:{color:"#ef4444"},children:"Error de Conexi√≥n"}),t.jsx("p",{style:{fontSize:"1.5vw",marginTop:"1rem"},children:v}),t.jsx("p",{style:{fontSize:"1vw",marginTop:"2rem",color:"#aaa"},children:"Verifica la consola para m√°s detalles. Reintentando..."})]}):o==="initializing"?t.jsx("div",{style:m,children:t.jsx("h1",{children:"Inicializando Dispositivo..."})}):o==="pairing"?t.jsxs("div",{style:m,children:[t.jsx("h1",{style:{fontSize:"3vw"},children:"Introduce este c√≥digo en tu panel de administraci√≥n:"}),I?t.jsx("div",{style:C,children:I}):t.jsx("p",{children:"Obteniendo c√≥digo..."})]}):o==="paired"?f?(console.error("Screen validation failed:",f),t.jsxs("div",{style:m,children:[t.jsx("h1",{style:{color:"#ef4444"},children:"Error de Validaci√≥n"}),t.jsx("p",{style:{fontSize:"1.5vw",marginTop:"1rem"},children:"La pantalla no est√° correctamente emparejada. Reiniciando..."})]})):k?t.jsx("div",{style:m,children:t.jsx("h1",{children:"Validando Pantalla..."})}):t.jsx(j,{playlistId:g,isPreview:!1}):null}T.createRoot(document.getElementById("root")).render(t.jsx(P,{client:E,children:t.jsx($,{defaultTheme:"light",storageKey:"xcientv-ui-theme",children:t.jsxs(b,{children:[t.jsx(N,{}),t.jsx(D,{})]})})}));
