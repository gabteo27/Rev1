import{a as d,e as x,j as e,$ as j,a3 as w,a0 as T,I as k,a1 as E,T as P,a2 as C}from"./index-Wxfa0Jtf.js";const c={position:"fixed",top:0,left:0,width:"100vw",height:"100vh",backgroundColor:"#000",color:"white",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",fontFamily:"sans-serif",textAlign:"center",padding:"1rem"},z={fontSize:"5vw",fontWeight:"bold",letterSpacing:"1vw",padding:"2rem",border:"2px solid #fff",borderRadius:"1rem",backgroundColor:"#333",marginTop:"2rem"},b=()=>{let t=localStorage.getItem("deviceHardwareId");return t||(t=`device_${Date.now()}_${Math.random().toString(36).substring(2,10)}`,localStorage.setItem("deviceHardwareId",t)),t};function $(){const[t,l]=d.useState("initializing"),[m,f]=d.useState(null),[v,I]=d.useState(null),[s,u]=d.useState(void 0),{data:o,isLoading:S,error:h}=x({queryKey:["/api/player/validate-token"],queryFn:async()=>{const r=localStorage.getItem("authToken");if(!r)throw new Error("No auth token found");const i=await fetch("/api/player/validate-token",{headers:{Authorization:`Bearer ${r}`}});if(!i.ok)throw new Error("Token validation failed");return i.json()},retry:(r,i)=>i.message.includes("Token validation failed")?!1:r<3,refetchInterval:3e4,enabled:t==="paired",onError:r=>{console.error("Token validation error:",r),localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),l("initializing")}});return d.useEffect(()=>{const r=localStorage.getItem("authToken");if(r){fetch("/api/player/validate-token",{headers:{Authorization:`Bearer ${r}`}}).then(a=>{a.ok?l("paired"):(localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),l("initializing"))}).catch(()=>{localStorage.removeItem("authToken"),localStorage.removeItem("screenName"),localStorage.removeItem("playlistId"),l("initializing")});return}const i=b();(async()=>{try{const a=await fetch("/api/screens/initiate-pairing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({deviceHardwareId:i})});if(!a.ok){const n=await a.json();throw new Error(n.message||"No se pudo obtener el código del servidor.")}const p=await a.json();f(p.pairingCode),l("pairing")}catch(a){I(a.message),l("error"),console.error("Error al iniciar emparejamiento:",a)}})();const y=setInterval(async()=>{if(!(t!=="pairing"&&document.visibilityState!=="visible"))try{const a=encodeURIComponent(i),p=await fetch(`/api/screens/pairing-status/${a}`);if(!p.ok)return;const n=await p.json();n.status==="paired"&&(console.log("¡Emparejamiento exitoso!",n),localStorage.setItem("authToken",n.authToken),localStorage.setItem("screenName",n.name),n.playlistId?localStorage.setItem("playlistId",n.playlistId.toString()):localStorage.removeItem("playlistId"),clearInterval(y),l("paired"))}catch(a){console.error("Error durante el polling de estado:",a)}},3e3);return()=>clearInterval(y)},[t]),d.useEffect(()=>{var r;if(o!=null&&o.valid&&((r=o.screen)!=null&&r.playlistId))console.log(`Screen playlist ID: ${o.screen.playlistId}, Current: ${s}`),o.screen.playlistId!==s&&(console.log(`Updating playlist ID from ${s} to ${o.screen.playlistId}`),u(o.screen.playlistId));else{const i=new URLSearchParams(window.location.search),g=i.get("playlistId")?parseInt(i.get("playlistId")):void 0;g&&!s&&u(g)}},[o,s]),t==="error"?e.jsxs("div",{style:c,children:[e.jsx("h1",{style:{color:"#ef4444"},children:"Error de Conexión"}),e.jsx("p",{style:{fontSize:"1.5vw",marginTop:"1rem"},children:v}),e.jsx("p",{style:{fontSize:"1vw",marginTop:"2rem",color:"#aaa"},children:"Verifica la consola para más detalles. Reintentando..."})]}):t==="initializing"?e.jsx("div",{style:c,children:e.jsx("h1",{children:"Inicializando Dispositivo..."})}):t==="pairing"?e.jsxs("div",{style:c,children:[e.jsx("h1",{style:{fontSize:"3vw"},children:"Introduce este código en tu panel de administración:"}),m?e.jsx("div",{style:z,children:m}):e.jsx("p",{children:"Obteniendo código..."})]}):t==="paired"?h?(console.error("Screen validation failed:",h),e.jsxs("div",{style:c,children:[e.jsx("h1",{style:{color:"#ef4444"},children:"Error de Validación"}),e.jsx("p",{style:{fontSize:"1.5vw",marginTop:"1rem"},children:"La pantalla no está correctamente emparejada. Reiniciando..."})]})):S?e.jsx("div",{style:c,children:e.jsx("h1",{children:"Validando Pantalla..."})}):e.jsx(j,{playlistId:s,isPreview:!1}):null}w.createRoot(document.getElementById("root")).render(e.jsx(T,{client:k,children:e.jsx(E,{defaultTheme:"light",storageKey:"xcientv-ui-theme",children:e.jsxs(P,{children:[e.jsx(C,{}),e.jsx($,{})]})})}));
